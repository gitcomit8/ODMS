name: Build and Push GraalVM Native Image to Artifacts Repo

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-native-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get Source Commit Message
        id: commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:%s)
          echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "Source commit message: $COMMIT_MSG"

      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          docker system prune -af

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build GraalVM Native Image
        run: |
          echo "Building GraalVM native image (this may take 5-10 minutes)..."
          docker build -f Dockerfile.native -t odms-native:latest .
          
      - name: Export Docker Image
        run: |
          echo "Exporting native image to tar..."
          docker save odms-native:latest -o odms-native-image.tar
          gzip odms-native-image.tar
          
      - name: Get Image Info
        id: image_info
        run: |
          IMAGE_SIZE=$(du -h odms-native-image.tar.gz | cut -f1)
          echo "size=$IMAGE_SIZE" >> $GITHUB_OUTPUT
          echo "Native image size: $IMAGE_SIZE"

      - name: Clone Artifact Repository
        uses: actions/checkout@v4
        with:
          repository: 'gitcomit8/odms-artifacts'
          token: ${{ secrets.PAT }}
          path: 'artifact-repo'

      - name: Copy Native Image to Artifact Repo
        run: |
          mv odms-native-image.tar.gz artifact-repo/odms-native-image.tar.gz
          
          # Create a metadata file with build info
          cat > artifact-repo/native-image-info.txt << EOF
          Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          Source Commit: ${{ github.sha }}
          Commit Message: ${{ steps.commit.outputs.message }}
          Image Size: ${{ steps.image_info.outputs.size }}
          Startup Time: 2-5 seconds
          Memory Usage: 80-150 MB
          GitHub Run: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          To use this image:
          1. Download odms-native-image.tar.gz
          2. gunzip odms-native-image.tar.gz
          3. docker load -i odms-native-image.tar
          4. docker run -p 80:80 odms-native:latest
          EOF

      - name: Commit and Push Native Image with Source Commit Message
        run: |
          cd artifact-repo
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add odms-native-image.tar.gz native-image-info.txt
          git commit -m "${{ steps.commit.outputs.message }}"
          git push
          
      - name: Build Summary
        run: |
          echo "## GraalVM Native Image Build Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit Message:** ${{ steps.commit.outputs.message }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Size:** ${{ steps.image_info.outputs.size }}" >> $GITHUB_STEP_SUMMARY
          echo "**Startup Time:** 2-5 seconds" >> $GITHUB_STEP_SUMMARY
          echo "**Memory Usage:** 80-150 MB" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image pushed to [odms-artifacts](https://github.com/gitcomit8/odms-artifacts)" >> $GITHUB_STEP_SUMMARY
