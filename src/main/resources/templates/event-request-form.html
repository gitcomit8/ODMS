<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>New Event OD Request</title>
    <link rel="stylesheet" th:href="@{/css/modern-style.css}">
    <style>
        body {
            background: var(--light-bg);
        }

        .header {
            text-align: center;
            padding: 2rem 0;
            animation: fadeInDown 0.6s ease-out;
        }

        .header h1 {
            font-size: 2.5rem;
        }

        .form-icon {
            font-size: 4rem;
            animation: bounce 2s ease-in-out infinite;
            display: block;
            margin-bottom: 1rem;
        }

        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .actions {
            margin-top: 1.5rem;
            display: flex;
            gap: 1rem;
        }

        .btn-add {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(17, 153, 142, 0.3);
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
        }

        .btn-remove {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 2px 10px rgba(250, 112, 154, 0.3);
        }

        .btn-remove:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
        }

        .btn-submit {
            background: var(--primary-gradient);
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            width: 100%;
            margin-top: 2rem;
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
        }

        input[readonly] {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            cursor: not-allowed;
        }

        .participant-row {
            animation: slideIn 0.3s ease-out;
        }

        .table-wrapper {
            overflow-x: auto;
            overflow-y: visible;
        }

        #participantTable {
            position: relative;
            overflow: visible !important;
        }

        #participantTable tbody {
            overflow: visible !important;
        }

        #participantTable tr {
            overflow: visible !important;
        }

        #participantTable td {
            overflow: visible !important;
            position: relative;
        }

        .autocomplete-wrapper {
            position: relative;
            display: block;
            width: 100%;
            z-index: 1;
        }

        .autocomplete-items {
            position: absolute;
            border: 1px solid #d1d5db;
            border-top: none;
            z-index: 9999 !important;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 300px;
            max-height: 250px;
            overflow-y: auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border-radius: 0 0 8px 8px;
            margin-top: 1px;
        }

        .autocomplete-items div {
            padding: 12px;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
            white-space: normal;
            word-wrap: break-word;
            display: block !important;
        }

        .autocomplete-items div:hover {
            background-color: #f0f4ff;
        }

        .autocomplete-items div:last-child {
            border-bottom: none;
        }

        .autocomplete-active {
            background-color: #e8f0fe !important;
        }

        .autocomplete-items div strong {
            color: #667eea;
            font-weight: 600;
        }

        .autocomplete-items div small {
            display: block;
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .event-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <span class="form-icon">üìù</span>
        <h1>Submit OD Request</h1>
        <p style="color: var(--text-secondary); font-size: 1.1rem;">Create a new event on-duty request</p>
    </div>

    <form action="#" method="post" th:action="@{/event-requests/submit}" th:object="${eventRequest}">
        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>
        
        <fieldset class="card">
            <legend><h3>üìÖ Event Details</h3></legend>
            <div class="event-details">
                <div class="form-group">
                    <label for="eventName">Event Name *</label>
                    <input id="eventName" required th:field="*{eventName}" type="text" placeholder="Enter event name">
                </div>

                <div class="form-group">
                    <label for="startDate">Start Date *</label>
                    <input id="startDate" required th:field="*{startDate}" type="date">
                </div>

                <div class="form-group">
                    <label for="endDate">End Date *</label>
                    <input id="endDate" required th:field="*{endDate}" type="date">
                </div>

                <div class="form-group">
                    <label for="fromTime">From Time *</label>
                    <input id="fromTime" required th:field="*{fromTime}" type="time">
                </div>

                <div class="form-group">
                    <label for="toTime">To Time *</label>
                    <input id="toTime" required th:field="*{toTime}" type="time">
                </div>

                <div class="form-group">
                    <label for="facultyCoordinator">Faculty Coordinator *</label>
                    <select id="facultyCoordinator" required th:field="*{facultyCoordinator.id}">
                        <option value="">-- Select Faculty --</option>
                        <option th:each="faculty : ${allFaculty}"
                                th:text="${faculty.facultyName + ' (' + faculty.branch + '-' + faculty.section + ')'}"
                                th:value="${faculty.id}">
                        </option>
                    </select>
                </div>
            </div>
        </fieldset>

        <fieldset class="card">
            <legend><h3>üë• Participants</h3></legend>
            <div class="table-wrapper">
                <table id="participantTable">
                    <thead>
                    <tr>
                        <th>Registration No *</th>
                        <th>Full Name</th>
                        <th>Year</th>
                        <th>Branch</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr class="participant-row" th:each="participant, itemStat : *{participants}">
                        <td>
                            <div class="autocomplete-wrapper">
                                <input class="regNoInput" oninput="handleAutocomplete(this)" onblur="handleBlur(this)"
                                       onfocus="handleFocus(this)" required th:field="*{participants[__${itemStat.index}__].regNo}" type="text" placeholder="Reg No"/>
                            </div>
                        </td>
                        <td><input class="nameInput" readonly th:field="*{participants[__${itemStat.index}__].name}"
                                   type="text" placeholder="Auto-filled"/></td>
                        <td><input class="yearInput" readonly
                                   th:field="*{participants[__${itemStat.index}__].academicYr}" type="number" placeholder="Year"/></td>
                        <td><input class="branchInput" readonly th:field="*{participants[__${itemStat.index}__].branch}"
                                   type="text" placeholder="Branch"/></td>

                        <input class="sectionInput" th:field="*{participants[__${itemStat.index}__].section}" type="hidden"/>
                        <input class="departmentInput" th:field="*{participants[__${itemStat.index}__].department}"
                               type="hidden"/>

                        <td>
                            <button class="btn-remove" onclick="removeRow(this)" type="button">Remove</button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="actions">
                <button class="btn-add" onclick="addRow()" type="button">‚ûï Add Participant</button>
            </div>
        </fieldset>

        <button class="btn-submit" type="submit">üöÄ Submit Request</button>
    </form>
</div>

<script>
    let autocompleteTimeout;
    let currentFocus = -1;

    async function handleAutocomplete(input) {
        const query = input.value.trim();
        closeAllLists();

        if (!query) return;

        clearTimeout(autocompleteTimeout);
        autocompleteTimeout = setTimeout(async () => {
            await fetchSuggestions(input, query);
        }, 300); // Debounce for 300ms
    }

    async function fetchSuggestions(input, query) {
        try {
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            const response = await fetch(`/api/students/search?query=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: {
                    [header]: token
                }
            });

            if (!response.ok) {
                console.log('API response not OK:', response.status);
                return;
            }

            const suggestions = await response.json();
            console.log('Suggestions received:', suggestions.length, suggestions);
            
            if (suggestions.length === 0) {
                console.log('No suggestions found for query:', query);
                return;
            }

            const wrapper = input.closest('.autocomplete-wrapper');
            if (!wrapper) {
                console.error('Autocomplete wrapper not found');
                return;
            }

            const listDiv = document.createElement('div');
            listDiv.setAttribute('class', 'autocomplete-items');
            listDiv.setAttribute('id', input.id + '-autocomplete-list');

            suggestions.forEach((student, index) => {
                const itemDiv = document.createElement('div');
                const regNo = student.regNo;
                const matchIndex = regNo.toUpperCase().indexOf(query.toUpperCase());
                
                let displayRegNo = regNo;
                if (matchIndex > -1) {
                    displayRegNo = regNo.substring(0, matchIndex) + 
                                   '<strong>' + regNo.substring(matchIndex, matchIndex + query.length) + '</strong>' +
                                   regNo.substring(matchIndex + query.length);
                }

                itemDiv.innerHTML = displayRegNo + 
                                    '<small>' + student.name + ' - Year ' + student.year + ' (' + student.branch + ')</small>';
                
                itemDiv.style.display = 'block'; // Ensure visibility
                
                itemDiv.addEventListener('click', function(e) {
                    selectStudent(input, student);
                    closeAllLists();
                });

                itemDiv.addEventListener('mousedown', function(e) {
                    e.preventDefault(); // Prevent blur event
                });

                listDiv.appendChild(itemDiv);
            });

            wrapper.appendChild(listDiv);
            console.log('Dropdown created with', suggestions.length, 'items');

        } catch (error) {
            console.error('Error fetching suggestions:', error);
        }
    }

    function selectStudent(input, student) {
        input.value = student.regNo;
        const row = input.closest('tr');
        
        row.querySelector('.nameInput').value = student.name;
        row.querySelector('.yearInput').value = student.year;
        row.querySelector('.branchInput').value = student.branch;
        
        // Fetch full details to get section and department
        fetchStudentDetails(input);
    }

    function handleFocus(input) {
        if (input.value.trim()) {
            handleAutocomplete(input);
        }
    }

    function handleBlur(input) {
        setTimeout(() => {
            closeAllLists();
            fetchStudentDetails(input);
        }, 200);
    }

    function closeAllLists(element) {
        const items = document.getElementsByClassName('autocomplete-items');
        Array.from(items).forEach(item => {
            if (element !== item && element !== item.previousSibling) {
                item.parentNode.removeChild(item);
            }
        });
        currentFocus = -1;
    }

    // Handle keyboard navigation
    document.addEventListener('keydown', function(e) {
        const activeInput = document.activeElement;
        if (!activeInput.classList.contains('regNoInput')) return;

        const wrapper = activeInput.closest('.autocomplete-wrapper');
        if (!wrapper) return;

        let list = wrapper.querySelector('.autocomplete-items');
        if (!list) return;

        const items = list.getElementsByTagName('div');
        
        if (e.keyCode === 40) { // Down arrow
            e.preventDefault();
            currentFocus++;
            addActive(items);
        } else if (e.keyCode === 38) { // Up arrow
            e.preventDefault();
            currentFocus--;
            addActive(items);
        } else if (e.keyCode === 13) { // Enter
            e.preventDefault();
            if (currentFocus > -1 && items[currentFocus]) {
                items[currentFocus].click();
            }
        } else if (e.keyCode === 27) { // Escape
            closeAllLists();
        }
    });

    function addActive(items) {
        if (!items) return false;
        removeActive(items);
        
        if (currentFocus >= items.length) currentFocus = 0;
        if (currentFocus < 0) currentFocus = items.length - 1;
        
        items[currentFocus].classList.add('autocomplete-active');
        items[currentFocus].scrollIntoView({ block: 'nearest' });
    }

    function removeActive(items) {
        Array.from(items).forEach(item => {
            item.classList.remove('autocomplete-active');
        });
    }

    async function fetchStudentDetails(element) {
        const regNo = element.value.trim();
        const row = element.closest('tr');

        if (!regNo) return;

        try {
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            const response = await fetch(`/api/students/${regNo}`, {
                method: 'GET',
                headers: {
                    [header]: token
                }
            });

            if (!response.ok) {
                alert('Student with Registration Number ' + regNo + ' not found!');
                row.querySelectorAll('input:not(.regNoInput)').forEach(input => input.value = '');
                return;
            }

            const student = await response.json();

            row.querySelector('.nameInput').value = student.name;
            row.querySelector('.yearInput').value = student.academicYear;
            row.querySelector('.branchInput').value = student.branch;
            row.querySelector('.sectionInput').value = student.section;
            row.querySelector('.departmentInput').value = student.department;

        } catch (error) {
            console.error('Error fetching student details:', error);
            alert('An error occurred. Please check the console.');
        }
    }

    function addRow() {
        const tableBody = document.getElementById('participantTable').getElementsByTagName('tbody')[0];
        const newIndex = tableBody.rows.length;
        const newRow = tableBody.insertRow();
        newRow.className = 'participant-row';

        newRow.innerHTML = `
        <td>
            <div class="autocomplete-wrapper">
                <input type="text" name="participants[${newIndex}].regNo" oninput="handleAutocomplete(this)" onblur="handleBlur(this)" onfocus="handleFocus(this)" class="regNoInput" placeholder="Reg No" required />
            </div>
        </td>
        <td>
            <input type="text" name="participants[${newIndex}].name" class="nameInput" placeholder="Auto-filled" readonly />
        </td>
        <td>
            <input type="number" name="participants[${newIndex}].academicYr" class="yearInput" placeholder="Year" readonly />
        </td>
        <td>
            <input type="text" name="participants[${newIndex}].branch" class="branchInput" placeholder="Branch" readonly />
        </td>

        <input type="hidden" name="participants[${newIndex}].section" class="sectionInput" />
        <input type="hidden" name="participants[${newIndex}].department" class="departmentInput" />

        <td>
            <button type="button" class="btn-remove" onclick="removeRow(this)">Remove</button>
        </td>
    `;
    }

    function removeRow(button) {
        const tableBody = document.getElementById('participantTable').getElementsByTagName('tbody')[0];

        if (tableBody.rows.length <= 1) {
            alert("At least one participant is required.");
            return;
        }

        button.closest('tr').remove();
    }

    // Close autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.classList.contains('regNoInput')) {
            closeAllLists();
        }
    });
</script>
</body>
</html>