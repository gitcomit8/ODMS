<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>New Event OD Request</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
        }

        .container {
            display: grid;
            gap: 20px;
        }

        .event-details {
            display: grid;
            grid-template-columns: 150px 300px;
            gap: 10px;
        }

        label {
            font-weight: bold;
        }

        input {
            padding: 8px;
            box-sizing: border-box;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        .actions {
            margin-top: 10px;
        }

        button {
            padding: 8px 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h1>Submit OD Request for an Event</h1>

<form action="#" class="container" method="post" th:action="@{/event-requests/submit}" th:object="${eventRequest}">
    <fieldset>
        <legend><h3>Event Details</h3></legend>
        <div class="event-details">
            <label for="eventName">Event Name:</label>
            <input id="eventName" required th:field="*{eventName}" type="text">

            <label for="eventDate">Event Date:</label>
            <input id="eventDate" required th:field="*{eventDate}" type="date">

            <label for="fromTime">From Time:</label>
            <input id="fromTime" required th:field="*{fromTime}" type="time">

            <label for="toTime">To Time:</label>
            <input id="toTime" required th:field="*{toTime}" type="time">
        </div>
    </fieldset>

    <fieldset>
        <legend><h3>Participants</h3></legend>
        <table id="participantTable">
            <thead>
            <tr>
                <th>Registration No</th>
                <th>Full Name</th>
                <th>Year</th>
                <th>Branch</th>
                <th>Action</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="participant, itemStat : *{participants}">
                <td>
                    <input class="regNoInput" onblur="fetchStudentDetails(this)"
                           required th:field="*{participants[__${itemStat.index}__].registrationNumber}" type="text"/>
                </td>
                <td><input class="nameInput" readonly th:field="*{participants[__${itemStat.index}__].name}"
                           type="text"/></td>
                <td><input class="yearInput" readonly
                           th:field="*{participants[__${itemStat.index}__].academicYear}" type="number"/></td>
                <td><input class="branchInput" readonly th:field="*{participants[__${itemStat.index}__].branch}"
                           type="text"/></td>

                <input class="sectionInput" th:field="*{participants[__${itemStat.index}__].section}" type="hidden"/>
                <input class="departmentInput" th:field="*{participants[__${itemStat.index}__].department}"
                       type="hidden"/>

                <td>
                    <button onclick="removeRow(this)" type="button">Remove</button>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="actions">
            <button onclick="addRow()" type="button">Add Participant</button>
        </div>
    </fieldset>

    <button type="submit">Submit Entire Request</button>
</form>

<script>
    async function fetchStudentDetails(element) {
        const regNo = element.value.trim();
        const row = element.closest('tr');

        if (!regNo) return;

        try {
            const response = await fetch(`/api/students/${regNo}`);

            if (!response.ok) {
                alert('Student with Registration Number ' + regNo + ' not found!');
                // Clear the fields if student not found
                row.querySelectorAll('input:not(.regNoInput)').forEach(input => input.value = '');
                return;
            }

            const student = await response.json();

            // Populate the visible and hidden fields in the same row
            row.querySelector('.nameInput').value = student.name;
            row.querySelector('.yearInput').value = student.academicYear;
            row.querySelector('.branchInput').value = student.branch;
            row.querySelector('.sectionInput').value = student.section;
            row.querySelector('.departmentInput').value = student.department;

        } catch (error) {
            console.error('Error fetching student details:', error);
            alert('An error occurred. Please check the console.');
        }
    }

    function addRow() {
        const tableBody = document.getElementById('participantTable').getElementsByTagName('tbody')[0];

        const newIndex = tableBody.rows.length;

        const newRow = tableBody.insertRow();

        newRow.innerHTML = `
        <td>
            <input type="text" name="participants[${newIndex}].registrationNumber" onblur="fetchStudentDetails(this)" class="regNoInput" required />
        </td>
        <td>
            <input type="text" name="participants[${newIndex}].name" class="nameInput" readonly />
        </td>
        <td>
            <input type="number" name="participants[${newIndex}].academicYear" class="yearInput" readonly />
        </td>
        <td>
            <input type="text" name="participants[${newIndex}].branch" class="branchInput" readonly />
        </td>

        <input type="hidden" name="participants[${newIndex}].section" class="sectionInput" />
        <input type="hidden" name="participants[${newIndex}].department" class="departmentInput" />

        <td>
            <button type="button" onclick="removeRow(this)">Remove</button>
        </td>
    `;
    }

    function removeRow(button) {
        const tableBody = document.getElementById('participantTable').getElementsByTagName('tbody')[0];

        if (tableBody.rows.length <= 1) {
            alert("At least one participant is required.");
            return; // Stop the function here
        }

        button.closest('tr').remove();
    }
</script>
</body>
</html>